# WebkitGTK 4.0.
# None of Geany's plugins are compatible with libsoup3, so this specific version
# of WebkitGTK has to be built. This is by far the biggest time sink of building
# locally, and it is impossible to avoid at this juncture. If you're building
# loccally, I *highly* recommend using the --ccache option to flatpak-builder.

name: webkit2gtk-4.0
buildsystem: cmake-ninja
config-opts:
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  - -DPORT=GTK
  - -DUSE_GTK4=OFF
  - -DUSE_SOUP2=ON  # This makes it build webkit2gtk-4.0 instead of 4.1.
  - -DUSE_LIBSECRET=OFF
  - -DUSE_LIBBACKTRACE=OFF
  - -DENABLE_GAMEPAD=OFF
  - -DENABLE_INTROSPECTION=OFF
  - -DENABLE_SPELLCHECK=OFF
  - -DENABLE_DOCUMENTATION=OFF
  - -DENABLE_MINIBROWSER=OFF
  - -DENABLE_BUBBLEWRAP_SANDBOX=OFF  # Unused inside of flatpak
sources:
  - type: archive
    url: https://webkitgtk.org/releases/webkitgtk-2.44.2.tar.xz
    sha256: 523f42c8ff24832add17631f6eaafe8f9303afe316ef1a7e1844b952a7f7521b
    x-checker-data:
      type: html
      url: https://webkitgtk.org/releases/
      version-pattern: LATEST-STABLE-(\d[\.\d]+\d)
      url-template: https://webkitgtk.org/releases/webkitgtk-$version.tar.xz
  - type: shell
    commands:
      - sed -i 's@NAMES avif.h@NAMES avif/avif.h@' Source/cmake/FindAVIF.cmake
      - sed -i '/PATH_SUFFIXES avif/d' Source/cmake/FindAVIF.cmake
      - sed -i 's@${AVIF_INCLUDE_DIR}/avif.h@${AVIF_INCLUDE_DIR}/avif/avif.h@' Source/cmake/FindAVIF.cmake
modules:
  - name: unifdef
    no-autogen: true
    make-install-args:
      - prefix=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://dotat.at/prog/unifdef/unifdef-2.12.tar.xz
        sha256: 43ce0f02ecdcdc723b2475575563ddb192e988c886d368260bc0a63aee3ac400
        x-checker-data:
          type: anitya
          project-id: 5046
          url-template: https://dotat.at/prog/unifdef/unifdef-$version.tar.xz
    cleanup:
      - '*'
